#+TITLE: Nix configuration for MacOS

using [[https://github.com/LnL7/nix-darwin][nix-darwin]] and home-manger

* Install

*** Install single-user Nix

#+begin_src sh
sh <(curl https://nixos.org/nix/install)
#+end_src

*** Add nixpkgs channel
#+begin_src sh
nix-channel --add https://nixos.org/channels/nixpkgs-unstable
nix-channel --update
#+end_src

*** TODO add note about latest OS and the workaround

** Install nix-darwin
** Download EssentialPragmataPro zip file to ~private~ directory (optional)

* In General
** home-manager's channel version must match the nixpkgs version
For example: 
if we are using 19.09 channel, our home-manager channel should
#+BEGIN_SRC shell
home-manager https://github.com/rycee/home-manager/archive/release-19.09.tar.gz
nixpkgs https://nixos.org/channels/nixpkgs-19.09-darwin
#+END_SRC

otherwise, there can be unexpected issues.

** [[https://github.com/LnL7/nix-darwin#updating][Update]]

#+BEGIN_SRC shell
nix-channel --update darwin
darwin-rebuild changelog
#+END_SRC

** How to pin down git branch
#+BEGIN_SRC shell
nix-prefetch-git https://github.com/target/lorri.git 61caab4d1a79fe7ec9470d5670677ee3e8b84e4f > lorri.json
#+END_SRC

* Content
** Shell - zsh
** Window Manager (Yabai + skhd + spacebar)
** Terminal Emulator - Kitty
- https://github.com/stephen-huan/macos-dotfiles/tree/master/.config/kitty

- https://github.com/koekeishiya/dotfiles/tree/master/kitty
** Editor - Doom emacs
https://tecosaur.github.io/emacs-config/config.html

* Caveats
** ~services.nix~ doesn't seem work with single user mode
** ~fontconfig~ doesn't work for MacOS ?
** Exclude Nix directory from Spotlight index

* Overlays
- https://nixos.wiki/wiki/Overlays
- https://discourse.nixos.org/t/creating-a-simple-overlay/1737/7
- https://nixos.org/nixpkgs/manual/#chap-overlays
- https://www.youtube.com/watch?v=W85mF1zWA2o
- https://nbp.github.io/slides/NixCon/2017.NixpkgsOverlays/

* References and Manual:
- https://daiderd.com/nix-darwin/manual/index.html#sec-options
- https://rycee.gitlab.io/home-manager/index.html

* Examples
- https://github.com/jwiegley/nix-config
- https://github.com/bkase/life
- https://github.com/tviti/nix-cfg
- https://github.com/danieldk/nix-home
- https://github.com/LnL7/dotfiles
- https://github.com/cmacrae/config
- https://github.com/peel/dotfiles

- https://www.sam.today/blog/derivations-102-learning-nix-pt-4/

* Items of TODO
** TODO using ~niv~
** TODO try to turn some config into a module
https://github.com/danieldk/nix-home/blob/master/modules/emacs-init.nix
** DONE give move doom emacs configuration
** STRT Kitty Configuration
** STRT setup yabai and skhd
- https://www.youtube.com/watch?v=AdwhjIg_Xe4
- https://github.com/stephen-huan/macos-dotfiles
- https://github.com/cmacrae/config/blob/master/conf.d/skhd.conf
- https://github.com/koekeishiya/skhd
- https://gist.github.com/knowler/ef937408198d4ee38ce111ae1a3da750
  https://piratefache.ch/chunkwm-is-dead-reborn-as-yabai/
  
* Common commands
- darwin-rebuild switch -I darwin-config=$HOME/.config/nixpkgs/darwin-configuration.nix
** How to refresh ~Dock.app~
~killall Dock~
